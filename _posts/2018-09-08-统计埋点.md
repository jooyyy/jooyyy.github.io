## 统计埋点

用户的实际交互量化数据是一项非常有价值的信息，产品的迭代和方案的 选择后期对于用户行为数据的需求会越来越大。统计埋点要做的，就是在用户与 App 产生交互之后，将数据收集，发送到服务端。

#### 常规的埋点方式

在进入页面和产生交互的同时向服务端发送交互数据，这种简单的方式有许多弊端

- 复用性差，埋点代码都是具体业务相关，其他项目或者新的功能模块没发复用
- 工作量大，每一处需要统计的地方都要加代码
- 引入与逻辑无关的代码



有没有一种方案可以非侵入式的，一次性解决同一类事件的统计呢？

#### 解决方案

* iOS Method Swizzling 即 runtime 方法注入

  ```
  #import "UIViewController+swizzling.h"
  #import <objc/runtime.h>
  
  @implementation UIViewController(swizzling)
  
  +(void)load {
      SEL origSel = @selector(viewDidAppear:);
      SEL swizSel = @selector(swiz_viewDidAppear:);
      [UIViewController swizzMethods:[self class] originalSelector:origSel swizzledSelector:swizSel];
  }
  
  +(void)swizzMethods:(Class)class originalSelector:(SEL)origSel swizzledSelector:(SEL)swizSel {
      Method origMethod = class_getInstanceMethod(class, origSel);
      Method swizMethod = class_getInstanceMethod(class, swizSel);
      BOOL didAddMethod = class_addMethod(class, origSel, method_getImplementation(swizMethod), method_getTypeEncoding(swizMethod));
      if(didAddMethod) {
          class_replaceMethod(class, swizSel, method_getImplementation(origMethod), method_getTypeEncoding(origMethod));
      }else {
          method_exchangeImplementations(origMethod, swizMethod);
      }
  }
  
  -(void)swiz_viewDidAppear:(BOOL)animated {
      NSLog(@"--->  i ma in [siwz_viewDidappear");
      [self swiz_viewDidAppear:animated];
  }
  
  @end
  ```

  load() 是入口方法，当 ViewController 类被读到内存后，runtime 会给每个类发送load消息，在这里添加注入方法，将默认方法和添加了统计的方法调换。

#### 进阶

Method Swizzling 需要创建 category 文件，hook 的类越多，创建的文件越多。

使用 [Aspect 库](https://github.com/steipete/Aspects)，直接对类或者类的对象进行 hook。相当于用统一的接口再次封装了 Method Swizzling的初始化步骤。