---
layout:     post
title:      EOS 相关归纳
subtitle:   
date:       2018-05-22
author:     Joy
header-img: img/page-bg-people.png
catalog: true
tags:
    - EOS blockchain
---


EOS 主网上线在即，目前最火的周边工具类应用就是 EOS 钱包映射工具，映射的原因和原理：
* 原因：EOS 在 ETH 平台上完成众筹之后，会迁移到自己的主网上，需要将 ETH 地址上的 EOS 代币数量1:1转移到 EOS 链上。
* 原理：映射用到的合约源码如下 --
	```
	function register(string key) {
		assert(today() <= numberOfDays + 1);
		assert(bytes(key).length <= 64);
		keys[msg.sender] = key;
		LogRegister(msg.sender, key);
	}
	```	
	要求在众筹结束后的一天之内，提供一个64个字符以内的 EOS 地址，用 keys map 将调用合约的 ETH 地址和这个提供的 EOS 地址关联起来，最后记录 Log。 

##### EOS 钱包生成过程

* 首先生成256位随机数，假设得到这个结果
	> p = "0x662391c59b82a93fc6d67726f825537b749ac019839c038be9eea2a67a982d2c"  // 16进制表示
* 接着对这一串结果进行 WIF 处理
	> WIF 



##### EOS account 数据结构
通过get_account接口可以拿到account的数据内容
```
eg:

{
	"account_name": "eosio",
	"permissions": [{
		"perm_name": "active",
		"parent": "owner",
		"required_auth": {
			"threshold": 1,
			"keys": [{
				"key": "EOS6M......",
				"weight": 1
			}],
			"accounts": []
		}       
	
	}, 
	{
		"perm_name": "owner",
		"parent": "",
		"requied_auth": {
			"threshold": 1,
			"keys": [{
				"key": 	"EOS6M......",
				"weight": 1
			}],
			"accounts": []
		},		
	}]
}

```
从数据结构可以看到一个account有多个permission，一个permission下有多个key，这里的key看上去就是wallet的公钥格式，外带一个权重weight。
> An account is a human-readable identifier that is stored on the blockchain. Every transaction has its permissions evaluated under the configured authority of an account. Each named permission has a threshold that must be met for a transaction signed under that authority to be considered valid. Transactions are signed by utilizing a client that has a loaded and unlocked wallet. A wallet is software that protects and makes use of your keys. These keys may or may not be granted permission to an account authority on the blockchain.(账号是一个存在链上的方便用户记忆的标识。每一笔交易都是通过一个账号授权之后才拥有操作许可。每一种操作都预先设置有一个门槛，达到这个门槛操作才被认为合法。每笔交易都是利用一个已有的且已经打开的钱包来签名的。钱包是用来安全存放你全部的key的软件。这些key可能已经被或者还未被一个链上的账号授予操作权限。)

* 每一个账号有两个自带的许可证
	* owner     	最基本的权限，用来证明对一个账号的所有权
	* active 	 	用来转移资产，投票和一些其他的高级账号操作

##### Docker 快速启动
* docker run --name nodeos -p 8888:8888 -p 9876:9876 -t eosio/eos nodeosd.sh arg1 arg2

##### 三个命令行工具
* cleos
	* 创建一个Wallet
	```
		➜  ~ cleos wallet create  
		Creating wallet: default
		Save password to use in the future to unlock this wallet.
		Without password imported keys will not be retrievable.
		"PW5KgkqX1vUnJqePwZZU3pVMDdnGnSsQho1iseULRrLN6FBL3URHF"

		或者夹带名称
		➜  ~ cleos wallet create -n joywallet  
		Creating wallet: joywallet
		Save password to use in the future to unlock this wallet.
		Without password imported keys will not be retrievable.
		"PW5KgkqX1vUnJqePwZZU3pVMDdnGnSsQho1iseULRrLN6FBL3URHF"

		jooyyy
		PW5JCaxgK65qSfmHeCuBCFvDQqNZ3BePeCd6mvTDxhntvq7QoPVU7
	```
	* 显示列表
	```
		➜  ~ cleos wallet list  
		Wallets:
		[
		  "default *",
		  "joywallet *"
		]
	```	
	* 解锁一个钱包
  	```
  		➜  ~ cleos wallet unlock -n default; 
  	```		
  	* 生成一个Key
  	```
  	cleos create key
  	```
  	* 通过cleos连接一个BP节点
  	```
  	cleos -u  https://api.helloeos.com.cn 	
  	```	
  	* 创建一个account
  		* 首先创建一个key pair用于新账号的permission key
  		```
  		➜  ~ cleos create key
		Private key: 5JDd3MJxZp9JtLR9JT41fkFCd5VJrWbKVzWCs445JphzH3jBnVy
		Public key: EOS7UV1PZktkNGFaBDbVRoo7SefyJEWkUhaFwh7ZyfJoF9XMSGDi7
  		```
  		* 把私钥存到钱包中
  		```
  		cleos wallet import 5JDd3MJxZp9JtLR9JT41fkFCd5VJrWbKVzWCs445JphzH3jBnVy
  		```
  		* 创建account，为其分配资源
  		```
  		➜  ~ cleos -u https://api.helloeos.com.cn system newaccount -x 1000 --stake-net "0.2 EOS" --stake-cpu "0.2 EOS" --buy-ram-kbytes 8 haydimjrgmge jooyyy EOS7UV1PZktkNGFaBDbVRoo7SefyJEWkUhaFwh7ZyfJoF9XMSGDi7 EOS7UV1PZktkNGFaBDbVRoo7SefyJEWkUhaFwh7ZyfJoF9XMSGDi7	
  		```	
  		* 查询account balance 
  		```
  		curl --request POST \
  		cleos -u https://api.helloeos.com.cn get account haydimjrgmge
  		cleos -u https://api.helloeos.com.cn get currency balance eosio.token haydimjrgmge
  		```

  		* 创建一个待签名的交易
  		```
  		cleos -u https://api.helloeos.com.cn transfer -j -s -d -x 300 haydimjrgjoy haydimjrgmge  "0.1 EOS" joy

  		cleos transfer -j -s -d -x 300 haydimjrgjoy haydimjrgmge  "0.1 EOS" joy


  		{
		  "expiration": "2018-06-20T09:54:21",
		  "ref_block_num": 44105,
		  "ref_block_prefix": 817303383,
		  "max_net_usage_words": 0,
		  "max_cpu_usage_ms": 0,
		  "delay_sec": 0,
		  "context_free_actions": [],
		  "actions": [{
		      "account": "eosio.token",
		      "name": "transfer",
		      "authorization": [{
		          "actor": "haydimjrgmge",
		          "permission": "active"
		        }
		      ],
		      "data": "a09864f74997bc69e0e963f74997bc69e80300000000000004454f5300000000036a6f79"
		    }
		  ],
		  "transaction_extensions": [],
		  "signatures": [],
		  "context_free_data": []
		}

  		```
  		* 对交易签名
  		```
  		cleos sign 
  		cleos sign '{"expiration":"2018-06-20T11:30:31","ref_block_num":55109,"ref_block_prefix":178900285,"max_net_usage_words":0,"max_cpu_usage_ms":0,"delay_sec":0,"context_free_actions":[],"actions":[{"account":"eosio.token","name":"transfer","authorization":[{"actor":"haydimjrgmge","permission":"active"}],"data":"a09864f74997bc69e0e963f74997bc69e80300000000000004454f5300000000036a6f79"}],"transaction_extensions":[],"signatures":[],"context_free_data":[]}' -k 5JDd3MJxZp9JtLR9JT41fkFCd5VJrWbKVzWCs445JphzH3jBnVy -c aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906

  		{
		  "expiration": "2018-06-20T10:17:12",
		  "ref_block_num": 46313,
		  "ref_block_prefix": 2837508678,
		  "max_net_usage_words": 0,
		  "max_cpu_usage_ms": 0,
		  "delay_sec": 0,
		  "context_free_actions": [],
		  "actions": [{
		      "account": "eosio.token",
		      "name": "transfer",
		      "authorization": [{
		          "actor": "haydimjrgmge",
		          "permission": "active"
		        }
		      ],
		      "data": "a09864f74997bc69e0e963f74997bc69e80300000000000004454f5300000000036a6f79"
		    }
		  ],
		  "transaction_extensions": [],
		  "signatures": [
		    "SIG_K1_K1hkwAGBu16KPsnYVuv2fJEhvA7DRYF9Wrxj7LzBZx8X3REHN2LEtQ2Zf5dz5sWtLhSFrBGhJTHd8H9hHxsggLLhcHGkhi"
		  ],
		  "context_free_data": []
		}
  		```
  		* 广播内容
  		```
  		cleos -u https://api.helloeos.com.cn push transaction '{"expiration":"2018-06-20T10:17:12","ref_block_num":46313,"ref_block_prefix":2837508678,"max_net_usage_words":0,"max_cpu_usage_ms":0,"delay_sec":0,"context_free_actions":[],"actions":[{"account":"eosio.token","name":"transfer","authorization":[{"actor":"haydimjrgmge","permission":"active"}],"data":"a09864f74997bc69e0e963f74997bc69e80300000000000004454f5300000000036a6f79"}],"transaction_extensions":[],"signatures":["SIG_K1_KeSTgieKAyFk2GYALigHBVMvLwwa14LMP37tdkeTyPK6eeExNvhT5hyDCx1XYq4jXnXZgVsXnSpG9UCuNGhNa8kzmvTST9"],"context_free_data":[]}'

  		```

  		cleos -u https://api.helloeos.com.cn

  		cleos -u https://api.helloeos.com.cn system newaccount -x 1000 -s -j -d --stake-net "0 EOS" --stake-cpu 0 --buy-ram-kbytes 8 haydimjrgmge joyyy EOS7UV1PZktkNGFaBDbVRoo7SefyJEWkUhaFwh7ZyfJoF9XMSGDi7 EOS7UV1PZktkNGFaBDbVRoo7SefyJEWkUhaFwh7ZyfJoF9XMSGDi7
  

  * 手动配置 binaryen


genesis.json

{
  "initial_timestamp": "2018-03-01T12:00:00.000",
  "initial_key": "EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV",
  "initial_configuration": {
    "base_per_transaction_net_usage": 100,
    "base_per_transaction_cpu_usage": 500,
    "base_per_action_cpu_usage": 1000,
    "base_setcode_cpu_usage": 2097152,
    "per_signature_cpu_usage": 100000,
    "per_lock_net_usage": 32,
    "context_free_discount_cpu_usage_num": 20,
    "context_free_discount_cpu_usage_den": 100,
    "max_transaction_cpu_usage": 10485760,
    "max_transaction_net_usage": 104857,
    "max_block_cpu_usage": 104857600,
    "target_block_cpu_usage_pct": 1000,
    "max_block_net_usage": 1048576,
    "target_block_net_usage_pct": 1000,
    "max_transaction_lifetime": 3600,
    "max_transaction_exec_time": 0,
    "max_authority_depth": 6,
    "max_inline_depth": 4,
    "max_inline_action_size": 4096,
    "max_generated_transaction_count": 16,
    "max_transaction_delay": 3888000
  },
  "initial_chain_id": "0000000000000000000000000000000000000000000000000000000000000000"
}


##### EOS node 服务器搭建
* 获取代码
	> git clone https://github.com/EOSIO/eos --recursive



#### 任务进度